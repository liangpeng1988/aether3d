<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnimationMaterial ç€è‰²å™¨æµ‹è¯•</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #info {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            z-index: 100;
            max-width: 300px;
        }
        
        #status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .success {
            background: rgba(76, 175, 80, 0.3);
            color: #4CAF50;
        }
        
        .error {
            background: rgba(244, 67, 54, 0.3);
            color: #f44336;
        }
    </style>
</head>
<body>
    <div id="container">
        <canvas id="canvas"></canvas>
        <div id="info">
            <h3>ğŸ§ª WebGL2 AnimationMaterial ç€è‰²å™¨æµ‹è¯•</h3>
            <p>æµ‹è¯•åŸºäºç°åº¦å€¼çš„é€æ˜åº¦æ§åˆ¶åŠŸèƒ½ï¼ˆæ–°ç‰ˆæœ¬ï¼‰</p>
            <div id="status">æ­£åœ¨åˆå§‹åŒ–...</div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://unpkg.com/three@0.154.0/build/three.module.js';
        
        let scene, camera, renderer;
        let statusElement;
        
        function init() {
            statusElement = document.getElementById('status');
            
            try {
                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x222222);
                
                // åˆ›å»ºç›¸æœº
                const canvas = document.getElementById('canvas');
                camera = new THREE.PerspectiveCamera(
                    75, 
                    canvas.clientWidth / canvas.clientHeight, 
                    0.1, 
                    1000
                );
                camera.position.set(0, 5, 10);
                camera.lookAt(0, 0, 0);
                
                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ 
                    canvas: canvas,
                    antialias: true 
                });
                renderer.setSize(canvas.clientWidth, canvas.clientHeight);
                renderer.shadowMap.enabled = true;
                renderer.shadowMap.type = THREE.PCFSoftShadowMap;
                
                // æ·»åŠ å…‰æº
                const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                directionalLight.position.set(10, 10, 5);
                directionalLight.castShadow = true;
                scene.add(directionalLight);
                
                // åˆ›å»ºæµ‹è¯•çº¹ç†ï¼ˆé»‘ç™½æ¸å˜ï¼‰
                const canvas2d = document.createElement('canvas');
                canvas2d.width = 512;
                canvas2d.height = 512;
                const ctx = canvas2d.getContext('2d');
                
                // åˆ›å»ºå¾„å‘æ¸å˜ï¼ˆä¸­å¿ƒç™½è‰²ï¼Œè¾¹ç¼˜é»‘è‰²ï¼‰
                const gradient = ctx.createRadialGradient(256, 256, 0, 256, 256, 256);
                gradient.addColorStop(0, 'white');
                gradient.addColorStop(0.7, 'gray');
                gradient.addColorStop(1, 'black');
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, 512, 512);
                
                const texture = new THREE.CanvasTexture(canvas2d);
                
                // åˆ›å»ºç®€åŒ–çš„æµ‹è¯•æè´¨ï¼ˆä¸ä½¿ç”¨AnimationMaterialé¿å…ä¾èµ–é—®é¢˜ï¼‰
                const testMaterial = new THREE.MeshStandardMaterial({
                    map: texture,
                    transparent: true,
                    side: THREE.DoubleSide
                });
                
                // æ·»åŠ ç®€å•çš„é€æ˜åº¦æ§åˆ¶ç€è‰²å™¨ï¼ˆä½¿ç”¨WebGL2è¯­æ³•ï¼‰
                testMaterial.onBeforeCompile = function(shader) {
                    try {
                        // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ³¨å…¥ç€è‰²å™¨ä»£ç 
                        const customAlphaCode = `
                            // è‡ªå®šä¹‰ç°åº¦é€æ˜åº¦å¤„ç†
                            #ifdef USE_MAP
                                vec4 mapTexel = texture2D( map, vMapUv );
                                
                                // è®¡ç®—ç°åº¦å€¼ï¼ˆä½¿ç”¨æ ‡å‡†çš„äº®åº¦å…¬å¼ï¼‰
                                float grayscaleValue = dot(mapTexel.rgb, vec3(0.299, 0.587, 0.114));
                                
                                // é»‘è‰²é€æ˜æ•ˆæœ
                                float customAlpha = 1.0 - grayscaleValue;
                                
                                // ä½¿ç”¨clampå‡½æ•°ç¡®ä¿å€¼åœ¨æœ‰æ•ˆèŒƒå›´å†…
                                customAlpha = clamp(customAlpha, 0.0, 1.0);
                                
                                // åº”ç”¨è‡ªå®šä¹‰é€æ˜åº¦åˆ°diffuseColor
                                diffuseColor *= mapTexel;
                                diffuseColor.a = customAlpha; // ç›´æ¥è®¾ç½®é€æ˜åº¦
                                
                                // å¯¹äºæä½çš„é€æ˜åº¦ï¼Œç›´æ¥ä¸¢å¼ƒç‰‡å…ƒ
                                if (customAlpha < 0.1) {
                                    discard;
                                }
                            #endif
                        `;
                        
                        // åœ¨mapçš„includeä¹‹åæ³¨å…¥æˆ‘ä»¬çš„ä»£ç 
                        shader.fragmentShader = shader.fragmentShader.replace(
                            '#include <map_fragment>',
                            '#include <map_fragment>\\n' + customAlphaCode
                        );
                        
                        // ç§»é™¤åŸæœ‰çš„alphatestä»¥é¿å…é‡å¤å¤„ç†
                        shader.fragmentShader = shader.fragmentShader.replace(
                            '#include <alphatest_fragment>',
                            '// åŸæœ‰alphatestè¢«è‡ªå®šä¹‰å¤„ç†æ›¿ä»£'
                        );
                        
                        // åœ¨æœ€ç»ˆè¾“å‡ºé˜¶æ®µç¡®ä¿é€æ˜åº¦æ­£ç¡®åº”ç”¨
                        const finalAlphaCode = `
                            // ç¡®ä¿æœ€ç»ˆè¾“å‡ºçš„é€æ˜åº¦æ­£ç¡®
                            #ifdef USE_MAP
                                vec4 finalMapTexel = texture2D( map, vMapUv );
                                float finalGrayscale = dot(finalMapTexel.rgb, vec3(0.299, 0.587, 0.114));
                                float finalAlpha = 1.0 - finalGrayscale;
                                finalAlpha = clamp(finalAlpha, 0.0, 1.0);
                                
                                // ç›´æ¥è®¾ç½®æœ€ç»ˆè¾“å‡ºçš„alphaå€¼
                                gl_FragColor.a = finalAlpha;
                                
                                // å¯¹äºæä½é€æ˜åº¦ï¼Œè®¾ç½®ä¸ºå®Œå…¨é€æ˜
                                if (finalAlpha < 0.1) {
                                    gl_FragColor.a = 0.0;
                                }
                            #endif
                        `;
                        
                        // åœ¨æœ€ç»ˆè¾“å‡ºä¹‹å‰å¤„ç†é€æ˜åº¦
                        shader.fragmentShader = shader.fragmentShader.replace(
                            'gl_FragColor = vec4( outgoingLight, diffuseColor.a );',
                            'gl_FragColor = vec4( outgoingLight, diffuseColor.a );\\n' + finalAlphaCode
                        );
                        
                        updateStatus('âœ… WebGL2ç€è‰²å™¨ç¼–è¯‘æˆåŠŸï¼é»‘è‰²éƒ¨åˆ†åº”è¯¥æ˜¯é€æ˜çš„ã€‚', 'success');
                        
                    } catch (error) {
                        console.error('ç€è‰²å™¨ç¼–è¯‘é”™è¯¯:', error);
                        updateStatus('âŒ ç€è‰²å™¨ç¼–è¯‘å¤±è´¥: ' + error.message, 'error');
                    }
                };
                
                // åˆ›å»ºæµ‹è¯•å‡ ä½•ä½“
                const geometry = new THREE.PlaneGeometry(8, 8);
                const mesh = new THREE.Mesh(geometry, testMaterial);
                scene.add(mesh);
                
                // æ·»åŠ èƒŒæ™¯ç‰©ä½“æ¥éªŒè¯é€æ˜æ•ˆæœ
                const bgGeometry = new THREE.BoxGeometry(2, 2, 2);
                const bgMaterial = new THREE.MeshStandardMaterial({ 
                    color: 0xff4444 
                });
                const bgMesh = new THREE.Mesh(bgGeometry, bgMaterial);
                bgMesh.position.set(0, 0, -2);
                scene.add(bgMesh);
                
                // å¼€å§‹æ¸²æŸ“å¾ªç¯
                animate();
                
            } catch (error) {
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                updateStatus('âŒ åˆå§‹åŒ–å¤±è´¥: ' + error.message, 'error');
            }
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            // æ—‹è½¬èƒŒæ™¯ç«‹æ–¹ä½“
            if (scene.children.length > 2) {
                scene.children[scene.children.length - 1].rotation.x += 0.01;
                scene.children[scene.children.length - 1].rotation.y += 0.01;
            }
            
            renderer.render(scene, camera);
        }
        
        function updateStatus(message, type) {
            statusElement.textContent = message;
            statusElement.className = type;
        }
        
        // å¤„ç†çª—å£å¤§å°å˜åŒ–
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('canvas');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        });
        
        // åˆå§‹åŒ–
        init();
        
    </script>
</body>
</html>