<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰‡å½¢é›·è¾¾æ‰«æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #0c1234 0%, #1a1a2e 50%, #16213e 100%);
            font-family: Arial, sans-serif; color: white; overflow: hidden; 
        }
        .main-container { display: flex; height: 100vh; width: 100vw; }
        
        /* å·¦ä¾§3Dç”»å¸ƒ - ç”¨æˆ·åå¥½ï¼šå›¾ç‰‡åœ¨å·¦ */
        .canvas-section { flex: 1; position: relative; background: #000; }
        #container { width: 100%; height: 100%; }
        
        /* å³ä¾§æ§åˆ¶é¢æ¿ - ç”¨æˆ·åå¥½ï¼šæ–‡å­—åœ¨å³ï¼Œæ§ä»¶å±…ä¸­å¯¹é½ */
        .control-section {
            width: 300px; background: rgba(0, 0, 0, 0.9); padding: 20px;
            overflow-y: auto; display: flex; flex-direction: column; align-items: center;
        }
        .title { text-align: center; margin-bottom: 20px; color: #4fc3f7; }
        .control-group {
            width: 100%; margin-bottom: 15px; padding: 12px;
            background: rgba(255, 255, 255, 0.05); border-radius: 8px;
        }
        .control-group h3 { margin: 0 0 10px 0; font-size: 14px; color: #ffab40; text-align: center; }
        .control-item { margin-bottom: 8px; }
        .control-item label { display: block; margin-bottom: 4px; font-size: 11px; color: #e0e0e0; text-align: center; }
        
        /* åŸç”Ÿinput rangeæ»šåŠ¨æ¡ - ç”¨æˆ·åå¥½ */
        input[type="range"] {
            width: 100%; height: 4px; -webkit-appearance: none;
            background: rgba(255, 255, 255, 0.2); border-radius: 2px; outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px;
            background: #4fc3f7; border-radius: 50%; cursor: pointer;
        }
        
        button {
            width: 100%; padding: 8px; background: linear-gradient(45deg, #4fc3f7, #29b6f6);
            color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 11px;
        }
        button:hover { background: linear-gradient(45deg, #29b6f6, #0277bd); }
        button.active { background: linear-gradient(45deg, #ff5722, #f44336); }
        
        .value-display { text-align: center; font-size: 9px; color: #4fc3f7; margin-top: 2px; }
        
        .top-info {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 100; background: rgba(0, 0, 0, 0.8); padding: 8px 16px; border-radius: 15px;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="canvas-section">
            <div id="container"></div>
            <div class="top-info">
                <h2 style="margin:0;font-size:14px;color:#4fc3f7;">æ‰‡å½¢é›·è¾¾æ‰«æ</h2>
                <p style="margin:0;font-size:10px;color:#81c784;" id="statusInfo">é›·è¾¾æ‰«æç³»ç»Ÿ â€¢ å®æ—¶å‚æ•°æ§åˆ¶ â€¢ é¼ æ ‡æ‹–æ‹½æ—‹è½¬ç›¸æœº</p>
            </div>
        </div>

        <div class="control-section">
            <div class="title">
                <h1 style="font-size:18px;">é›·è¾¾æ§åˆ¶å°</h1>
                <p style="font-size:11px;color:#81c784;">æ‰‡å½¢é›·è¾¾æ‰«æå‚æ•°è°ƒèŠ‚</p>
            </div>

            <div class="control-group">
                <h3>â¯ï¸ åŠ¨ç”»æ§åˆ¶</h3>
                <div class="control-item"><button id="toggleAnimation">å¼€å§‹æ‰«æ</button></div>
                <div class="control-item"><button id="resetTime">é‡ç½®æ—¶é—´</button></div>
            </div>

            <div class="control-group">
                <h3>ğŸ›ï¸ é›·è¾¾å‚æ•°</h3>
                <div class="control-item">
                    <label for="speedSlider">æ‰«æé€Ÿåº¦</label>
                    <input type="range" id="speedSlider" min="0.1" max="5.0" step="0.1" value="1.5">
                    <div class="value-display" id="speedValue">1.5</div>
                </div>
                <div class="control-item">
                    <label for="radiusSlider">æ¢æµ‹åŠå¾„</label>
                    <input type="range" id="radiusSlider" min="20" max="100" step="5" value="50">
                    <div class="value-display" id="radiusValue">50</div>
                </div>
                <div class="control-item">
                    <label for="angleSlider">æ‰‡å½¢è§’åº¦</label>
                    <input type="range" id="angleSlider" min="0.5" max="6.28" step="0.1" value="1.57">
                    <div class="value-display" id="angleValue">90Â°</div>
                </div>
                <div class="control-item">
                    <label for="opacitySlider">é€æ˜åº¦</label>
                    <input type="range" id="opacitySlider" min="0.1" max="1.0" step="0.1" value="0.8">
                    <div class="value-display" id="opacityValue">80%</div>
                </div>
                <div class="control-item">
                    <label for="colorPicker">é›·è¾¾é¢œè‰²</label>
                    <input type="color" id="colorPicker" value="#00ff00" style="width:100%;height:30px;">
                </div>
            </div>

            <div class="control-group">
                <h3>ğŸ® ç›¸æœºæ§åˆ¶</h3>
                <div class="control-item"><button id="resetCamera">é‡ç½®ç›¸æœº</button></div>
                <div class="control-item"><button id="topView">ä¿¯è§†å›¾</button></div>
                <div class="control-item"><button id="frontView">æ­£è§†å›¾</button></div>
            </div>

            <div class="control-group">
                <h3>ğŸ—ï¸ æ¨¡å‹åŠ è½½</h3>
                <div class="control-item"><button id="loadModel">åŠ è½½FBXæ¨¡å‹</button></div>
                <div class="control-item"><button id="applyRadarToModel">åº”ç”¨é›·è¾¾æ•ˆæœ</button></div>
                <div class="control-item"><button id="removeModel">ç§»é™¤æ¨¡å‹</button></div>
            </div>

            <div class="control-group">
                <h3>ğŸš€ é¢„è®¾æ•ˆæœ</h3>
                <div class="control-item"><button onclick="setPreset('fast')">å¿«é€Ÿæ‰«æ</button></div>
                <div class="control-item"><button onclick="setPreset('wide')">å¹¿åŸŸæ¢æµ‹</button></div>
                <div class="control-item"><button onclick="setPreset('precise')">ç²¾ç¡®å®šä½</button></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Aether3d, BeforeMaterial, RadarMaterial, OrbitControlsScript, THREE } from '../../Engine';
        import { FBXLoader } from 'three/examples/jsm/loaders/FBXLoader.js';
        
        // ä½¿ç”¨Aether3då¼•æ“çš„æ‰‡å½¢é›·è¾¾å˜é‡
        let engine = null;
        let time = { value: 0 };
        let isAnimating = false;
        let radarMesh = null;
        let radarMaterial = null;
        let loadedModel = null; // FBXæ¨¡å‹
        let originalMaterials = new Map(); // ä¿å­˜åŸå§‹æè´¨
        let orbitControlsScript = null;

        let currentParams = {
            speed: 1.5,
            radius: 50,
            angle: Math.PI / 2, // 90åº¦
            opacity: 0.8,
            color: "#00ff00"
        };

        init();
        animate();
        
        // è‡ªåŠ¨å¯åŠ¨é›·è¾¾æ‰«æ
        setTimeout(() => {
            if (!isAnimating) {
                toggleAnimation();
            }
        }, 500);

        function init() {
            const container = document.getElementById('container');
            
            // åˆ›å»ºæˆ–è·å–canvaså…ƒç´ 
            let canvas = container.querySelector('canvas');
            if (!canvas) {
                canvas = document.createElement('canvas');
                canvas.style.width = '100%';
                canvas.style.height = '100%';
                canvas.style.display = 'block';
                container.appendChild(canvas);
            }
            
            // åˆå§‹åŒ–Aether3då¼•æ“
            engine = new Aether3d({
                element: canvas,
                dpr: new THREE.Vector2(container.clientWidth, container.clientHeight),
                alpha: false,
                antialias: true,
                factor: window.devicePixelRatio,
                distance: 5,
                aspect: container.clientWidth / container.clientHeight,
                enablePostProcessing: false,
                enablePerformanceMonitoring: true,
                backgroundColor: '#0a0a0a'
            });
            
            // è®¾ç½®ç›¸æœºä½ç½® - ä¿¯è§†è§’åº¦
            engine.camera.position.set(0, 80, 0);
            engine.camera.lookAt(0, 0, 0);
            
            // ä½¿ç”¨å¼•æ“çš„ç›¸æœºæ§åˆ¶ç³»ç»Ÿ
            orbitControlsScript = new OrbitControlsScript({
                enableDamping: true,
                dampingFactor: 0.05,
                minDistance: 30,
                maxDistance: 200,
                maxPolarAngle: Math.PI
            });
            engine.addScript(orbitControlsScript);
            
            // æ·»åŠ ç¯å¢ƒå…‰
            const ambientLight = new THREE.AmbientLight(0x404040, 0.3);
            engine.scene.add(ambientLight);
            
            // æ·»åŠ å‚è€ƒç½‘æ ¼
            const gridHelper = new THREE.GridHelper(120, 20, 0x333333, 0x333333);
            engine.scene.add(gridHelper);
            
            // æ·»åŠ è°ƒè¯•ç”¨çš„çº¿æ¡†ç«‹æ–¹ä½“ç¡®ä¿æ¸²æŸ“æ­£å¸¸
            const debugGeometry = new THREE.BoxGeometry(5, 5, 5);
            const debugMaterial = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00, 
                wireframe: true 
            });
            const debugCube = new THREE.Mesh(debugGeometry, debugMaterial);
            debugCube.position.set(0, 2.5, 0);
            engine.scene.add(debugCube);

            // æ·»åŠ ä¸€äº›å‚è€ƒå¯¹è±¡
            addReferenceObjects();

            window.addEventListener('resize', onWindowResize, false);
            initControls();
            createRadar();
            
            // å¯åŠ¨å¼•æ“æ¸²æŸ“å’Œæ›´æ–°å¾ªç¯
            engine.start();
            startEngineUpdateLoop();
        }

        function addReferenceObjects() {
            // æ·»åŠ ä¸€äº›ç«‹æ–¹ä½“ä½œä¸ºé›·è¾¾æ¢æµ‹ç›®æ ‡
            for (let i = 0; i < 10; i++) {
                const geometry = new THREE.BoxGeometry(2, 2, 2);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0x666666, 
                    wireframe: true 
                });
                const cube = new THREE.Mesh(geometry, material);
                
                cube.position.set(
                    (Math.random() - 0.5) * 80,
                    1,
                    (Math.random() - 0.5) * 80
                );
                
                engine.scene.add(cube);
            }

            // æ·»åŠ ä¸­å¿ƒæ ‡è®°
            const centerGeometry = new THREE.CylinderGeometry(1, 1, 3, 8);
            const centerMaterial = new THREE.MeshBasicMaterial({ color: 0xff0000 });
            const centerMarker = new THREE.Mesh(centerGeometry, centerMaterial);
            centerMarker.position.y = 1.5;
            engine.scene.add(centerMarker);
        }

        function createRadar() {
            // åˆ›å»ºå¤§åœ†å½¢å¹³é¢ä½œä¸ºé›·è¾¾æ‰«æåŒºåŸŸ
            const geometry = new THREE.CircleGeometry(currentParams.radius, 64);
            
            // ä½¿ç”¨æ–°çš„RadarMaterialåˆ›å»ºé›·è¾¾æ‰«ææ•ˆæœ
            radarMaterial = new RadarMaterial({
                color: currentParams.color,
                opacity: currentParams.opacity,
                speed: currentParams.speed,
                radius: currentParams.radius,
                angle: currentParams.angle,
                time: time
            });

            radarMesh = new THREE.Mesh(geometry, radarMaterial);
            radarMesh.rotation.x = -Math.PI / 2; // æ°´å¹³æ”¾ç½®
            radarMesh.position.y = 0.1; // ç¨å¾®æŠ¬é«˜é¿å…z-fighting
            engine.scene.add(radarMesh);

            console.log('âœ… æ‰‡å½¢é›·è¾¾åˆ›å»ºå®Œæˆ - ä½¿ç”¨Aether3då¼•æ“æ¶æ„å’ŒRadarMaterial');
            updateStatusInfo();
        }

        function initControls() {
            document.getElementById('toggleAnimation').addEventListener('click', toggleAnimation);
            document.getElementById('resetTime').addEventListener('click', () => { 
                time.value = 0; 
                console.log('æ—¶é—´å·²é‡ç½®');
            });

            document.getElementById('speedSlider').addEventListener('input', updateParams);
            document.getElementById('radiusSlider').addEventListener('input', updateParams);
            document.getElementById('angleSlider').addEventListener('input', updateParams);
            document.getElementById('opacitySlider').addEventListener('input', updateParams);
            document.getElementById('colorPicker').addEventListener('input', updateParams);

            // ç›¸æœºæ§åˆ¶äº‹ä»¶
            document.getElementById('resetCamera').addEventListener('click', resetCamera);
            document.getElementById('topView').addEventListener('click', setTopView);
            document.getElementById('frontView').addEventListener('click', setFrontView);

            // FBXæ¨¡å‹ç›¸å…³äº‹ä»¶
            document.getElementById('loadModel').addEventListener('click', loadFBXModel);
            document.getElementById('applyRadarToModel').addEventListener('click', applyRadarToModel);
            document.getElementById('removeModel').addEventListener('click', removeModel);

            updateDisplayValues();
        }

        function updateParams() {
            currentParams.speed = parseFloat(document.getElementById('speedSlider').value);
            currentParams.radius = parseFloat(document.getElementById('radiusSlider').value);
            currentParams.angle = parseFloat(document.getElementById('angleSlider').value);
            currentParams.opacity = parseFloat(document.getElementById('opacitySlider').value);
            currentParams.color = document.getElementById('colorPicker').value;

            // ä½¿ç”¨RadarMaterialçš„æ–¹æ³•æ›´æ–°å‚æ•°
            if (radarMaterial && radarMaterial instanceof RadarMaterial) {
                radarMaterial.updateParameters({
                    speed: currentParams.speed,
                    radius: currentParams.radius,
                    angle: currentParams.angle,
                    opacity: currentParams.opacity,
                    color: currentParams.color
                });
                
                // æ›´æ–°å‡ ä½•ä½“å¤§å°
                if (radarMesh && radarMesh.geometry) {
                    radarMesh.geometry.dispose();
                    radarMesh.geometry = new THREE.CircleGeometry(currentParams.radius, 64);
                }
            } else {
                // é‡æ–°åˆ›å»ºé›·è¾¾æ•ˆæœ
                if (radarMesh) {
                    engine.scene.remove(radarMesh);
                    createRadar();
                }
            }

            updateDisplayValues();
            updateStatusInfo();
        }

        function updateDisplayValues() {
            document.getElementById('speedValue').textContent = currentParams.speed.toFixed(1);
            document.getElementById('radiusValue').textContent = currentParams.radius.toString();
            document.getElementById('angleValue').textContent = Math.round(currentParams.angle * 180 / Math.PI) + 'Â°';
            document.getElementById('opacityValue').textContent = Math.round(currentParams.opacity * 100) + '%';
        }

        function updateStatusInfo() {
            const statusElement = document.getElementById('statusInfo');
            if (statusElement) {
                const status = isAnimating ? 'æ‰«æä¸­' : 'å¾…æœº';
                const angle = Math.round(currentParams.angle * 180 / Math.PI);
                const modelStatus = loadedModel ? ' â€¢ æ¨¡å‹å·²åŠ è½½' : '';
                const scanAngle = isAnimating ? ` â€¢ å½“å‰è§’åº¦: ${Math.round((time.value * currentParams.speed) % (2 * Math.PI) * 180 / Math.PI)}Â°` : '';
                statusElement.textContent = `çŠ¶æ€: ${status} â€¢ æ‰‡å½¢: ${angle}Â° â€¢ åŠå¾„: ${currentParams.radius}m${modelStatus}${scanAngle}`;
            }
        }

        function toggleAnimation() {
            isAnimating = !isAnimating;
            const btn = document.getElementById('toggleAnimation');
            btn.textContent = isAnimating ? 'åœæ­¢æ‰«æ' : 'å¼€å§‹æ‰«æ';
            btn.classList.toggle('active', isAnimating);
            
            console.log('é›·è¾¾æ‰«æçŠ¶æ€:', isAnimating ? 'å¼€å¯' : 'å…³é—­');
            
            // è°ƒè¯•ä¿¡æ¯ï¼šæ˜¾ç¤ºå½“å‰å‚æ•°
            if (isAnimating) {
                console.log('é›·è¾¾å‚æ•°:', {
                    speed: currentParams.speed,
                    radius: currentParams.radius,
                    angle: currentParams.angle,
                    angleDegrees: Math.round(currentParams.angle * 180 / Math.PI) + 'Â°',
                    time: time.value
                });
            }
            
            updateStatusInfo();
        }

        function setPreset(type) {
            const presets = {
                fast: { speed: 3.0, radius: 40, angle: 1.0, opacity: 0.9, color: '#ff0000' },
                wide: { speed: 1.0, radius: 80, angle: 2.0, opacity: 0.6, color: '#0066ff' },
                precise: { speed: 0.8, radius: 30, angle: 0.5, opacity: 0.9, color: '#00ff00' }
            };

            const preset = presets[type];
            if (preset) {
                Object.assign(currentParams, preset);
                
                document.getElementById('speedSlider').value = preset.speed;
                document.getElementById('radiusSlider').value = preset.radius;
                document.getElementById('angleSlider').value = preset.angle;
                document.getElementById('opacitySlider').value = preset.opacity;
                document.getElementById('colorPicker').value = preset.color;
                
                updateParams();
                console.log(`åº”ç”¨é¢„è®¾: ${type}`, preset);
            }
        }

        // ç›¸æœºæ§åˆ¶å‡½æ•°
        function resetCamera() {
            engine.camera.position.set(0, 60, 80);
            if (orbitControlsScript?.getControls()) {
                orbitControlsScript.getControls().target.set(0, 0, 0);
                orbitControlsScript.getControls().update();
            }
        }

        function setTopView() {
            engine.camera.position.set(0, 100, 0);
            if (orbitControlsScript?.getControls()) {
                orbitControlsScript.getControls().target.set(0, 0, 0);
                orbitControlsScript.getControls().update();
            }
        }

        function setFrontView() {
            engine.camera.position.set(0, 30, 80);
            if (orbitControlsScript?.getControls()) {
                orbitControlsScript.getControls().target.set(0, 0, 0);
                orbitControlsScript.getControls().update();
            }
        }

        function onWindowResize() {
            if (engine) {
                engine.resize();
            }
        }
        
        // FBXæ¨¡å‹åŠ è½½å’Œå¤„ç†åŠŸèƒ½
        function loadFBXModel() {
            // ç”±äºæ²¡æœ‰å®é™…çš„FBXæ–‡ä»¶ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæµ‹è¯•åŸå¸‚æ¨¡å‹
            createTestCityModel();
            
            /* å¦‚æœæœ‰å®é™…çš„FBXæ–‡ä»¶ï¼Œå¯ä»¥ä½¿ç”¨ä»¥ä¸‹ä»£ç ï¼š
            const loader = new FBXLoader();
            loader.load('./model/shanghai.fbx', (object) => {
                if (loadedModel) {
                    scene.remove(loadedModel);
                }
                
                loadedModel = object;
                object.scale.set(0.1, 0.1, 0.1); // è°ƒæ•´å¤§å°
                scene.add(object);
                
                console.log('FBXæ¨¡å‹åŠ è½½å®Œæˆ');
                updateStatusInfo();
            }, undefined, (error) => {
                console.error('FBXæ¨¡å‹åŠ è½½å¤±è´¥:', error);
                createTestCityModel(); // å›é€€åˆ°æµ‹è¯•æ¨¡å‹
            });
            */
        }
        
        function createTestCityModel() {
            if (loadedModel) {
                scene.remove(loadedModel);
            }
            
            const cityGroup = new THREE.Group();
            
            // åˆ›å»ºå¤šä¸ªä¸åŒé«˜åº¦çš„å»ºç­‘ç‰©
            for (let i = 0; i < 30; i++) {
                const height = 5 + Math.random() * 25;
                const width = 3 + Math.random() * 4;
                const depth = 3 + Math.random() * 4;
                
                const geometry = new THREE.BoxGeometry(width, height, depth);
                const material = new THREE.MeshLambertMaterial({ 
                    color: new THREE.Color(0.3, 0.3, 0.3),
                    transparent: true,
                    opacity: 0.8
                });
                
                const building = new THREE.Mesh(geometry, material);
                building.position.set(
                    (Math.random() - 0.5) * 100,
                    height / 2,
                    (Math.random() - 0.5) * 100
                );
                
                // ä¿å­˜åŸå§‹æè´¨å¼•ç”¨
                originalMaterials.set(building, material);
                
                cityGroup.add(building);
            }
            
            loadedModel = cityGroup;
            engine.scene.add(cityGroup);
            
            console.log('âœ… æµ‹è¯•åŸå¸‚æ¨¡å‹åˆ›å»ºå®Œæˆ - ä½¿ç”¨Aether3då¼•æ“æ¶æ„');
            updateStatusInfo();
        }
        
        function applyRadarToModel() {
            if (!loadedModel) {
                alert('è¯·å…ˆåŠ è½½æ¨¡å‹ï¼');
                return;
            }
            
            loadedModel.traverse((child) => {
                if (child.isMesh && child.material) {
                    handleRadarMaterial(child.material);
                }
            });
            
            console.log('âœ… é›·è¾¾æ•ˆæœå·²åº”ç”¨åˆ°æ¨¡å‹ - ä½¿ç”¨BeforeMaterial');
            updateStatusInfo();
        }
        
        function handleRadarMaterial(material) {
            if (Array.isArray(material)) {
                material.forEach((mat) => {
                    applyRadarEffect(mat);
                });
            } else {
                applyRadarEffect(material);
            }
        }
        
        function applyRadarEffect(material) {
            // ä½¿ç”¨RadarMaterialæ›¿æ¢åŸæœ‰æè´¨
            const radarMat = new RadarMaterial({
                color: currentParams.color,
                opacity: 0.5,
                speed: currentParams.speed,
                radius: currentParams.radius,
                angle: currentParams.angle,
                time: time
            });
            
            // å¤åˆ¶åŸºæœ¬å±æ€§
            Object.assign(material, radarMat);
        }
        
        function removeModel() {
            if (loadedModel) {
                engine.scene.remove(loadedModel);
                loadedModel = null;
                originalMaterials.clear();
                console.log('âœ… æ¨¡å‹å·²ç§»é™¤ - ä½¿ç”¨Aether3då¼•æ“æ¶æ„');
                updateStatusInfo();
            }
        }

        // å¼•æ“æ›´æ–°å¾ªç¯
        function startEngineUpdateLoop() {
            const updateScript = {
                update: animate
            };
            engine.addScript(updateScript);
        }

        function animate() {
            if (isAnimating) {
                time.value += 0.015;
                
                // æ›´æ–°RadarMaterialæ—¶é—´
                if (radarMaterial && radarMaterial instanceof RadarMaterial) {
                    radarMaterial.updateTime(0.015);
                }
                
                // æ›´æ–°çŠ¶æ€ä¿¡æ¯
                if (Math.floor(time.value * 60) % 60 === 0) {
                    updateStatusInfo();
                }
            }
        }
    </script>
</body>
</html>